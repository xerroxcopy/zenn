---
title: "Rã§ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’UMAPã§æ¬¡å…ƒåœ§ç¸®ã™ã‚‹éš›ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹æç”»ã®å·®ç•°ã‚’å¯è¦–åŒ–ã™ã‚‹"
emoji: "ğŸŒŒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ggplot", "r", "umap"]
published: false
---

å¡©æ¼¬ã‘ã«ã—ã¦ã„ãŸç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’è»½ã„æ°—æŒã¡ã§UMAPã‚’ä½¿ã£ã¦ã¿ã‚ˆã†ã¨æ€ã£ãŸã‚‰10å€‹ãã‚‰ã„å¼•ã£ã‹ã‹ã£ãŸã®ã§ãƒ¡ãƒ¢ã—ã¦ãŠãã€‚æœ€åˆã«æ„Ÿæƒ³ã ã‘æ›¸ã„ã¦ãŠãã¨ã€PCAãªã©ã§ã¯ã»ã¨ã‚“ã©æç”»å´ãŒã„ã˜ã‚Œã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªãã€ã‚ã£ã¦ã‚‚1-2è»¸ã§è¦‹ã›ã‚‹ã®ã‹ã€1-3è»¸ã§è¦‹ã›ã‚‹ã®ã‹ã€ã¯ãŸã¾ãŸ2-3è»¸ï¼ˆæ®†ã©è¦‹ãŸã“ã¨ãªã„ã‘ã©ï¼‰ã§è¦‹ã›ã‚‹ã®ã‹ã€ãã‚Œã¨ã‚‚3æ¬¡å…ƒã§è¦‹ã›ã‚‹ã®ã‹ãã‚‰ã„ã—ã‹å·®ãŒãªã„ã®ã«ã€UMAPã¯æ§˜ã€…ã«ã„ã˜ã‚Œã¦ã—ã¾ã†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹ï¼ˆä¸Šã«ã€ãã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¨­å®šã«ã¤ã„ã¦ç¾æ™‚ç‚¹ã§ã¯ã‚ã¾ã‚Šä½•ã‚‚æ‰¹åˆ¤çš„ã«è¨€ã‚ã‚Œã¦ã„ãªã„ã‚ˆã†ã«æ€ã†ï¼‰ãŸã‚ã€ã•ã¾ã–ã¾ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è©¦ã—ã¦ã‹ã‚‰è‡ªåˆ†ã®æ€ã„é€šã‚Šã«ã€æ£æ„çš„ã«é¸ã¹ã‚‹æ°—ãŒã—ã¦å±ã†ã„ã€‚


# libraries

ã‚‚ã¯ã‚„ã©ã‚ŒãŒå¿…è¦ã§ã©ã‚ŒãŒå¿…è¦ã§ãªã‹ã£ãŸã‹ã‚ã‹ã‚‰ãªããªã£ãŸãŒ
```r
library(umap)
library(tidyverse)
library(snedata) # install via remotes::install_github("jlmelville/snedata")
library(imager) # for images
library(purrr)
library(Rtsne)  # https://github.com/jkrijthe/Rtsne
```

# UMAPã®ç·´ç¿’

ã¾ãšã¯UMAPãŒèµ°ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚
```r
iris_umap <- iris |> 
  select(where(is.numeric)) |> 
  umap()
iris_df <- iris_umap$layout |> 
  as_tibble() |> 
  transmute(x = V1, y = V2) |> 
  mutate(labels = iris$Species)
iris_df |> 
  ggplot(aes(x = x, y = y, color = labels)) +
  geom_point()
ggsave("./output/iris_umap.png", height = 1000, width = 1500, unit = "px")
```
![](/images/umap-tsne-in-r/iris_umap.png)

åŒæ§˜ã«ã€`MNIST`ã«ã¤ã„ã¦[ã“ã“](https://jlmelville.github.io/uwot/umap-examples.html)ã‚’å‚è€ƒã«ã‚„ã‚‹ã€‚ã—ã‹ã—`mnist`ãƒ‡ãƒ¼ã‚¿ã‚’`snedata`ã‹ã‚‰è½ã¨ã—ãŸã‚‚ã®ã‚’ç›´æ¥`UMAP`ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€`as.numeric()`ã§`integer`ã‚’`double`ã«ã™ã‚‹ã€‚ã€‚ã€‚ã“ã‚ŒãŒåŸå› ãªã®ã‹ã‚ˆãã‚ã‹ã‚‰ãªã„ãŒå‹•ãã®ã§ãƒ¨ã‚·
ã¾ãŸã€`Label`åˆ—ã¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ç”¨ã®ãƒ©ãƒ™ãƒ«ã€ã„ã‚ã°ã€Œæ­£è§£ã€ãªã®ã§ã»ã‚“ã¨ã†ã¯æŠœã„ã¦ã‹ã‚‰è¨ˆç®—ã™ã¹ãã ãŒã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã¯ãã®ã‚ˆã†ã«ãªã£ã¦ã„ãªã„ã€‚
`umap()`ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä¸¦åˆ—åŒ–ã•ã‚Œã¦ã„ã‚‹ã‚‰ã—ã„ãŒã€ã¡ã‚ƒã‚“ã¨`n_threads`ã‚’æŒ‡å®šã™ã‚‹ã¨æ—©ããªã‚‹æ°—ãŒã™ã‚‹â€¦ã€‚`verbose`ã¯`TRUE`ã«ã—ã¦ãŠãã¨å®Ÿè¡Œæ™‚é–“ã‚‚ã‚ã‹ã‚‹ã—ã€ã©ã“ã¾ã§è¨ˆç®—ãŒé€²ã‚“ã§ã„ã‚‹ã‹ã‚ã‹ã£ã¦å®‰å¿ƒã™ã€‚ã€‚
```r
mnist <- snedata::download_mnist()
mnist_umap <- umap(mnist, pca = 100) # error... :(
mnist_df <- mnist |> 
  as_tibble() |>  
  mutate(across(everything(), as.numeric)) |> 
  select(-Label) # ãƒ©ãƒ™ãƒ«åˆ—ã‚’è½ã¨ã™
mnist_umap <- mnist_df |> 
  umap(
  pca = 10, 
  verbose = TRUE, 
  n_threads = 6
  )

mnist_umap_df <- 
  mnist_umap$layout |> 
  as_tibble() |> 
  transmute(x = V1, y = V2) |> 
  mutate(label = mnist$Label)
mnist_umap_df |> 
  ggplot(aes(x = x, y = y, colour = label)) +
  geom_point(alpha = .5, size = .001) +
  theme_minimal()
ggsave("./output/mnist_umap.png", height = 1000, width = 1500, unit = "px")
```
![](/images/umap-tsne-in-r/mnist_umap.png)

# å‰å‡¦ç†â€“ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€ã²ã¨ã¤ã®å·¨å¤§ãªãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«ã™ã‚‹

æ‰‹å…ƒã«æ•°åæšç¨‹åº¦ã®æ­£æ–¹å½¢ã®jpgãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã¨ã™ã‚‹ã€‚[{imager}](https://dahtah.github.io/imager/imager.html)ã‚’ä½¿ã†ã®ã ãŒã€ã“ã“ã§ã‚‚ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«å¾“ã£ã¦`system.file('[path]', package = "imager")`ã‚’ä½¿ã†ã¨ã†ã¾ãã„ã‹ãªã„ã®ã§ã€ç›´æ¥æ”¾ã‚Šè¾¼ã‚“ã§ã—ã¾ã†ã€‚`input/`ãƒ•ã‚©ãƒ«ãƒ€ã«`000.jpg`, `001.jpg`, `002.jpg`... `041.jpg`ã¨42æšã®æ­£æ–¹å½¢ã®ç”»åƒãŒã‚ã£ãŸã¨ã—ã‚ˆã†ã€‚
ä»–ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã‘ã‚Œã°`list.files("input/", full.names=T) |> `ã§ã‚‚ã‚ˆã„ã®ã ãŒã€ä»–ã«ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«æ›¸ãã€‚
```r
df_image <- 
  paste0(
    "input/", 
    formatC(0:41, width = 3, flag = "0"),
    ".jpg"
  ) |> # ã™ã¹ã¦ã®ãƒ‘ã‚¹ã‚’stringã®ãƒ™ã‚¯ãƒˆãƒ«ã¨ã—ã¦æ›¸ãä¸‹ã™ã€‚ãƒ•ã‚©ãƒ«ãƒ€å†…ã«ä»–ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã‘ã‚Œã°`list.files()`ã§ã‚‚å¯
  map(~ load.image(file = .x)) |> # imagerã‚’purrr::mapã«æ¸¡ã—ã¦ä¸€æ°—ã«ãƒªã‚¹ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã‚€
  map(~ resize(im = .x, size_x = 128, size_y = 128)) |> # å—ã‘å–ã£ãŸç”»åƒã®ãƒªã‚¹ãƒˆã‚’ãƒªã‚µã‚¤ã‚ºã™ã‚‹ã€‚800*800ãã‚‰ã„ã‚ã£ãŸã®ã§â€¦ã€‚
  map(~ grayscale(im = .x)) |> # ã‚‚ã¨ã‚‚ã¨ã‚°ãƒ¬ã‚¤ã‚¹ã‚±ãƒ¼ãƒ«ã®ç”»åƒã ã£ãŸãŒãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã¯3ãƒãƒ£ãƒ³ãƒãƒ«ã‚ã£ãŸã®ã§å‰Šæ¸›
  map(~t(as.numeric(.))) |> # ã“ã“ã§ã¾ãŸæ•°å€¤ã«å¤‰æ›ã—ãªã„ã¨ã„ã‘ãªã„ã€‚ãªãœ
  map_dfr(~ as.data.frame(.)) # ã“ã®ã¾ã¾ã§ã¯ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ãªã®ã§ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã—ã¦ã‹ã‚‰ãã‚Œã‚‰ã‚’ç¸¦ã«ã²ã£ã¤ã‘ã‚‹(`map_dfr`)

```
128 * 128 = 16384 + tã®1åˆ—ã§16385åˆ—ã«å¯¾ã—ã¦ã€1è¡Œ1ç”»åƒãªã®ã§42æšãƒ»è¡Œã®éå¸¸ã«æ¨ªå¹…ã®å¤§ãã„ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ãŒã§ãã‚‹ã€‚

# UMAP

å…ˆç¨‹ã®MNISTã¨é•ã„ã€ã“ã¡ã‚‰ã¯è¡Œæ•°ãŒã‚‚ã®ã™ã”ãå°‘ãªã„ã®ã§ä¸€ç¬ã§çµ‚ã‚ã‚‹ã€‚ãƒ‡ãƒ¼ã‚¿ãŒå°ã•ã„ã®ã§PCAã¯å¿…è¦ãªã„ã¨åˆ¤æ–­ã—ãŸã€‚

```r
image_umap <- df_image |> 
  umap(verbose = TRUE, n_threads = 6)
```

## ãƒ—ãƒ­ãƒƒãƒˆ

```r
image_umap_df |> 
  ggplot(aes(x = x, y = y, colour = t)) +
  geom_point(size = .3) +
  geom_path() +
  geom_text(aes(label = t), hjust = 0, nudge_x = .1, size = 2) +
  scale_colour_viridis_c() +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line())
ggsave("./output/image_umap.png", height = 1000, width = 1500, unit = "px")
```
![](/images/umap-tsne-in-r/image_umap.png)
*tã®leakãŒãªã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³*
![](/images/umap-tsne-in-r/image_umap_leak.png)
*tã®åˆ—ã‚’æ®‹ã—ãŸã¾ã¾ã‚„ã£ã¦ã—ã¾ã£ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‚ã“ã‚“ãªã«é•ã†ã®ã‹â€¦*


## t-SNEã¨ã®æ¯”è¼ƒ

[R wrapper for Van der Maatenâ€™s Barnes-Hut implementation of t-Distributed Stochastic Neighbor Embedding](https://github.com/jkrijthe/Rtsne)ã‚’å‚è€ƒã«ã€ã‚ã¨[t-SNEã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚µã‚¤ã‚ºã¯ä½•ã‚‚æ„å‘³ã—ãªã„ã€è·é›¢ã‚‚ã‚ã‚“ã¾ã‚Šæ„å‘³ãªã„ã‹ã‚‚](https://distill.pub/2016/misread-tsne/)ã‚ãŸã‚Šã‚’è‚ã«éŠ˜ã˜ã¤ã¤t-SNEã‚‚ã‚„ã£ã¦ã¿ã‚‹ã€‚

Perplexityã¯[ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã®1/3ãŒä¸Šé™](https://www.slideshare.net/kato_kohaku/dimensionality-reduction-with-tsne-and-umap-using-r-176806642)(p21)ãªã®ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30ã§ã¯å‹•ã‹ãªã„ã€‚
```r
image_tsne <- df_image |>
  as.matrix() |> 
  Rtsne(
    perplexity = 12, # default 30, max datasize/3
    n_threads = 4,
    verbose = TRUE
  )
image_tsne_df <- image_tsne$Y |> 
  as_tibble() |> 
  rename(x = "V1", y = "V2") |> 
  mutate(t = 0:41)
image_tsne_df |> 
  ggplot(aes(x = x, y = y, colour = t)) +
  geom_point(size = .3) +
  geom_path() +
  geom_text(aes(label = t), hjust = 0, nudge_x = .1, size = 2) +
  scale_colour_viridis_c() +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line())
ggsave("./output/image_tsne.png", height = 1000, width = 1500, unit = "px")
```
![](/images/umap-tsne-in-r/image_tsne.png)
*LeakageãŒãªã„UMAPã¨åŒã˜ãã‚‰ã„ã®ã‚ã¡ã‚ƒãã¡ã‚ƒã ãŒã€ãªã‚“ã¨ãªãã“ã¡ã‚‰ã®ã»ã†ãŒã™ã£ãã‚Šã—ã¦ã‚‹â€¦ï¼Ÿ*

# UMAPã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹æç”»ã®å·®ç•°ã‚’å¯è¦–åŒ–ã™ã‚‹
[ã“ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã®p43](https://www.slideshare.net/kato_kohaku/dimensionality-reduction-with-tsne-and-umap-using-r-176806642)ã«ã‚ã‚‹`min_dist`ã¨`n_neighbors`ã‚’å¤‰ãˆãŸå ´åˆã®æç”»ã®å·®ã‚’ã¿ã¦ã€ã€ŒåŒã˜ãƒ‡ãƒ¼ã‚¿ã§ã“ã‚“ãªã«é•ã†å°è±¡ä¸ãˆã‚‰ã‚Œã‚‹UMAPã€ã¡ã‚‡ã£ã¨å±ãªã™ãã§ã¯ï¼Ÿã€ã¨æ€ã£ã¦è‡ªåˆ†ã§ã‚‚ã‚„ã£ã¦ã¿ã‚‹ã“ã¨ã«ã—ãŸã€‚ã²ã¨ã¤ã²ã¨ã¤ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§æç”»ã—ã¦ã‚‚ã‚ˆã„ã®ã ãŒã€ã›ã£ã‹ããªã®ã§`map()`ãªã©ã‚’å¤šç”¨ã—ã¦ä¸€æ°—ã«ã‚„ã£ã¦ã—ã¾ãŠã†ã¨æ€ã£ãŸã‚‰matrix-columnãŒç”Ÿæˆã•ã‚Œã¦å›°ã£ãŸãŒè§£æ±ºã—ãŸã€‚

ã¾ãš`min_dist`ã¨`n_neighbors`ãã‚Œãã‚Œã«ã¤ã„ã¦æç”»ã—ãŸã„å¤‰æ•°ã®çµ„ã¿åˆã‚ã›ã‚’`expand_grid()`ã§ç”Ÿæˆã™ã‚‹ã€‚`spread`ã¯ä»Šå›ã¯`2`ã§å›ºå®šã—ãŸ^[ä¸Šè¨˜ã‚¹ãƒ©ã‚¤ãƒ‰ã§ã¯`spread`ãŒ1ã«ãªã£ã¦ã„ã‚‹ãŒã€`min_dist`ã‚ˆã‚Šã‚‚å°ã•ã„å€¤ã‚’è¨­å®šã§ããªã„ã¯ãšãªã®ã§ã€`min_dist = 5`ã¯èª¤æ¤ã‹ãªã¨æ€ã†]ã€‚ãã‚Œãã‚Œã«å¯¾ã—ã¦`umap()`ã‚’`map2()`ã‚’ç”¨ã„ã¦è¡Œã†ã€‚ã‚‚ã—3ã¤ä»¥ä¸Šã®ãƒ‘ãƒ©ãƒ¡ã‚¿ã‚’åŒæ™‚ã«è©¦ã—ãŸã‘ã‚Œã°ã€ãŸã¶ã‚“`pmap()`ã‚’ä½¿ã†ã“ã¨ã«ãªã‚‹ã€‚
```r
nested_df_grid_conditions <- 
  expand_grid(min_dist = c(2^(-4:-1)), n_neighbors = 2^(1:4)) |> 
  mutate(
    umap = map2(
      min_dist, 
      n_neighbors,
      ~ umap(
        df_seven2,
        spread = 2,
        n_threads = 4, 
        min_dist = .x, # min_dist = min_distã§ã‚‚.min_distã«ã‚‚éãš
        n_neighbors = .y # åŒæ§˜
      )
    )
  )
```

`map2()`ã¯`list`ã‚’è¿”ã™ã€‚


